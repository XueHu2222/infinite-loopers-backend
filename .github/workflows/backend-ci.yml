# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Quest Giver Backend CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 24.x
      uses: actions/setup-node@v4
      with:
        node-version: 24.x
        
    - name: Install dependencies
      run: npm ci

    - name: Install service dependencies
      run: npm run install:all

    - name: Generate Prisma Clients
      run: npm run prisma:generate:all

    - name: Run ESLint
      run: npm run lint:all

    - name: Start all Docker services
      run: |
        docker compose up -d
        echo "Waiting for services to be ready..."
        for i in {1..15}; do
          if nc -z localhost 3012 && nc -z localhost 3010; then
            echo "Services are ready!"
            break
          fi
          echo "Waiting for services... ($i)"
          sleep 2
        done


    - name: Run tests
      run: npm test

    - name: Notify Microsoft Teams on failure
      if: failure()
      uses: jdcargile/ms-teams-notification@v1.2
      with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          ms-teams-webhook-uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
          notification-summary: Build failed in the "Quest Giver Backend CI" workflow
          notification-color: dc3545
